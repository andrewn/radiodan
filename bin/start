#!/usr/bin/env ruby
require 'eventmachine'
require 'em-synchrony'
require 'pathname'

ROOT = File.join(File.dirname(__FILE__), '..')

require_relative '../lib/radio-playlist'
require_relative '../lib/mpd'
require_relative '../lib/control'

EM.synchrony do
  @mpd = MPD.new

  Signal.trap("INT") do
    EM::Synchrony.next_tick do
      @mpd.stop
      EM.stop
    end
  end

  EM.error_handler do |e|
    puts "Error raised during event loop: #{e.message}"
    puts e.backtrace.join("\n")
  end
  
  EM::Synchrony.next_tick do
    # download BBC Radio playlists
    playlists = File.join(ROOT, 'playlists')
    r = RadioPlaylist.new(path: playlists)
    r.download

    EM::Synchrony.add_periodic_timer(30) do
      r.download
    end
  end

  EM::Synchrony.next_tick do
    # connect to MPD
    @mpd.playlist "bbc_radio_4"
  end

  EM::Synchrony.next_tick do
    # check for touched files
    @file_control = Control::File.new(@mpd)
    EM::Synchrony.add_periodic_timer(0.5) do
      @file_control.check
    end
  end
end
